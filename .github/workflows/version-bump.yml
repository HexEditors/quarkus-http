name: Version Bump on Main Merge

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'pom.xml'

jobs:
  bump-version:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Extract current revision
      id: extract
      run: |
        CURRENT_REVISION=$(grep -oP '<revision>\K[^<]+' pom.xml)
        echo "Current revision: $CURRENT_REVISION"
        echo "current_revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT

    - name: Bump version
      id: bump
      run: |
        CURRENT=${{ steps.extract.outputs.current_revision }}
        # Assume format x.y.z-SNAPSHOT, increment z
        IFS='.' read -r major minor patch <<< "${CURRENT%-SNAPSHOT}"
        NEW_PATCH=$((patch + 1))
        NEW_VERSION="$major.$minor.$NEW_PATCH-SNAPSHOT"
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Update pom.xml
      run: |
        sed -i "s|<revision>${{ steps.extract.outputs.current_revision }}</revision>|<revision>${{ steps.bump.outputs.new_version }}</revision>|" pom.xml

    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pom.xml
        git commit -m "Bump version to ${{ steps.bump.outputs.new_version }} [skip ci]" || echo "No changes to commit"
        git push
